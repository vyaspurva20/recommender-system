name: Test AI CI/CD Agent on Recommender

on:
  push:
    branches:
      - main

jobs:
  test-agent:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3️⃣ Install dependencies (optional, safe)
      - name: Install dependencies
        run: |
          pip install pandas

      # 4️⃣ Run recommender.py and capture error log
      - name: Run error.py
        run: |
          set +e  # continue even if script fails
          python  2> error.log error.py|| true

      # 5️⃣ Send error log to your LLM agent
      - name: Test LLM Agent
        env:
          AGENT_URL: ${{ secrets.LLM_AGENT_URL }}
        run: |
          LOG=$(cat error.log | sed ':a;N;$!ba;s/\n/\\n/g')
          RESPONSE=$(curl -s -X POST "$AGENT_URL" \
            -H "Content-Type: application/json" \
            -d "{\"log\": \"$LOG\"}")
          echo "=== LLM Agent Response ==="
          echo "$RESPONSE"
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

      # 6️⃣ Optional: warn if confidence is low
      - name: Check confidence
        run: |
          CONF=$(echo "$RESPONSE" | jq '.confidence')
          if (( $(echo "$CONF < 0.5" | bc -l) )); then
            echo "Warning: Low confidence from LLM agent"
          fi

