name: Logic CI + AI Fix Agent
permissions:
  contents: write
  pull-requests: write
on:
  push:
  pull_request:

jobs:
  run-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install streamlit pandas

      - name: Logic validation (no tests)
        run: |
          python - <<EOF
          import pickle, sys
          try:
              pickle.load(open("movies_dict.pkl","rb"))
              pickle.load(open("similarity.pkl","rb"))
              print("Logic OK")
          except Exception as e:
              print(e)
              sys.exit(1)
          EOF

      - name: Save error log
        if: failure()
        run: |
          echo "CI failed while validating logic" > error.log

      - name: Clone AI agent repo
        if: failure()
        run: |
          git clone https://github.com/Kashish-0931/ai-ci-agent-service.git

      -

  

      - name: Run AI Fix Agent
        if: failure()
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          pip install -r ai-ci-agent-service/requirements.txt
          python ai-ci-agent-service/ai_agent.py




