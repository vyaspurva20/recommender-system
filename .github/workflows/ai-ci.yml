permissions:
  contents: write
  pull-requests: write
name: Logic CI + AI Fix Agent

on:
  push:
  pull_request:

jobs:
  run-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install streamlit pandas

      - name: Logic validation
        id: validate
        run: python tests/test_ci_trigger.py


      - name: Save error log
        if: ${{ steps.validate.outcome == 'failure' }}
        run: |
          echo "CI failed while validating logic" > error.log

      - name: Clone AI agent repo
        if: ${{ steps.validate.outcome == 'failure' }}
        run: |
          git clone https://github.com/Kashish-0931/ai-ci-agent-service.git

      - name: Run AI Fix Agent
        if: ${{ steps.validate.outcome == 'failure' }}
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          pip install -r ai-ci-agent-service/requirements.txt
          python ai-ci-agent-service/ai_agent.py




